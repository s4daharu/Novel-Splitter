(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const Y=document.getElementById("setupView"),K=document.getElementById("editorView"),J=document.getElementById("fileInput"),X=document.getElementById("coverInput"),fe=document.getElementById("fileDropZone"),ge=document.getElementById("coverDropZone"),D=document.getElementById("chapterPattern"),he=document.getElementById("customRegexContainer"),z=document.getElementById("customRegexInput"),xe=document.getElementById("encodingSelect"),ye=document.getElementById("fileNameInfo"),M=document.getElementById("coverNameInfo"),G=document.getElementById("processBtn"),O=document.getElementById("status"),I=document.getElementById("matchPreview"),ve=document.getElementById("metaTitle"),Ee=document.getElementById("metaAuthor"),we=document.getElementById("epubTheme"),W=document.getElementById("cleanupRulesContainer"),Ie=document.getElementById("addRuleBtn"),be=document.getElementById("backBtn"),Be=document.getElementById("downloadZipBtn"),$e=document.getElementById("downloadEpubBtn"),E=document.getElementById("chapterList"),w=document.getElementById("chapterContent"),F=document.getElementById("splitChapterBtn"),B=document.getElementById("saveChapterBtn"),Q=document.getElementById("progressContainer"),q=document.getElementById("progressBar"),V=document.getElementById("progressText");let $="",L="",f=null,a=[],m=null,x=!1;function g(e,t){O.textContent=e,O.className="status small",t&&O.classList.add(t)}function U(){Q.style.display="block",u(0,"")}function A(){Q.style.display="none"}function u(e,t){const n=Math.max(0,Math.min(100,Math.round(e)));q.style.width=n+"%",V.textContent=n+"%"+(t?" – "+t:""),q.setAttribute("aria-valuenow",n),V.setAttribute("aria-label",`${n}% ${t}`)}function S(e){return String(e||"").replace(/[\u0000-\u001f]/g,"").replace(/[\\\/:*?"<>|]/g,"").replace(/\s+/g,"_").slice(0,180)||"untitled"}async function Ce(e,t){if(t==="auto"){try{return new TextDecoder("utf-8",{fatal:!0}).decode(e)}catch{}try{return new TextDecoder("gbk",{fatal:!0}).decode(e)}catch{}try{return new TextDecoder("big5",{fatal:!0}).decode(e)}catch{}return g("Auto-detection failed; file might be in an unsupported encoding. Displaying with UTF-8.","error"),new TextDecoder("utf-8").decode(e)}else return new TextDecoder(t,{fatal:!1}).decode(e)}function ee(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=()=>t(o.result),o.onerror=n,o.readAsArrayBuffer(e)})}function te(e,t){const n=document.createElement("a");n.href=URL.createObjectURL(e),n.download=t,document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>URL.revokeObjectURL(n.href),1500)}function Le(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function v(e){const t=document.createElement("div");return t.innerText=e,t.innerHTML}function Te(e){return{"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","image/svg+xml":"svg"}[e]||"img"}const T={chinese:/^\s*第\s*([0-9]+)\s*章[\.。:\s]?.*$/im,chinese_numeral:/^\s*第\s*([一二三四五六七八九十百千零〇]+)\s*章.*$/im,chapter:/^\s*Chapter\s*([0-9]+)\b.*$/im,ch:/^\s*Ch(?:apter)?\.?\s*([0-9]+)\b.*$/im,titledot:/^\s*([^\r\n]{1,120})\.\s*\d+\s*$/uim,parenfullwidth:/^\s*（\s*\d+\s*\.?\s*）\s*$/uim};function Pe(e){for(const t in T){const n=T[t];let o=0;for(let r=0;r<Math.min(e.length,400);r++)if(n.test(e[r])&&(o++,o>1))return{key:t,rx:n}}return null}function ne(){const e=D.value;if(e==="custom"){const t=z.value;if(!t)return{rx:null,key:"custom",error:"Please enter a custom Regex pattern."};try{return{rx:new RegExp(t,"im"),key:"custom"}}catch(n){return{rx:null,key:"custom",error:`Invalid Regex: ${n.message}`}}}if(e==="auto"){const t=($||"").split(/\r?\n/),n=Pe(t);return n?(D.value=n.key,n):{rx:null,key:"auto",error:"Auto-detect found no repeated heading pattern in first 400 lines."}}return{rx:T[e]||null,key:e}}function ke(e,t){const n=[];for(let o=0;o<Math.min(t.length,500)&&(e.test(t[o])&&n.push(t[o].trim()),!(n.length>=5));o++);return n}function Z(){if(!$){I.style.display="none";return}const e=$.split(/\r?\n/),t=ne();if(I.style.display="block",t.error){I.textContent=t.error;return}if(!t.rx){I.textContent="No pattern selected or detected.";return}const n=ke(t.rx,e);if(n.length){let o="";t.key==="auto"&&t.rx&&(o=`Auto-detected: ${Object.keys(T).find(i=>T[i]===t.rx)}. `),I.textContent=`${o}Matches: ${n.join(" | ")}`}else I.textContent="No matches found for this pattern in the first 500 lines."}function De(e){let t=e;return W.querySelectorAll('input[type="text"]').forEach(o=>{const r=o.value.trim();if(r)try{const i=new RegExp(r,"gim");t=t.replace(i,"")}catch(i){console.warn(`Invalid cleanup regex: ${r}`,i)}}),t}function Ae(e){const t=De(e),n=String(t).split(/\r?\n/),o=ne();if(o.error)return g(o.error,"error"),null;const r=o.rx;let i=[],s=null;const l=()=>{s&&i.push(s)};if(!r)i.push({title:"synopsis",content:t.trim()});else{let d=[];for(const h of n){const p=String(h||"");r.test(p)?(l(),s={title:p.trim(),content:""}):s?s.content+=p+`
`:d.push(p)}l(),i.unshift({title:"synopsis",content:d.join(`
`).trim()})}return i.map((d,h)=>({...d,id:h}))}function P(){E.innerHTML="",a.forEach((e,t)=>{const n=document.createElement("li");n.dataset.id=e.id,n.draggable=!0;const o=document.createElement("input");o.type="text",o.value=e.title,o.className="chapter-title",o.addEventListener("change",l=>{e.title=l.target.value});const r=document.createElement("div");r.className="chapter-actions";const i=document.createElement("button");i.textContent="Merge ↓",i.title="Merge this chapter down into the one above it",t===0&&(i.disabled=!0);const s=document.createElement("button");s.textContent="Del",s.title="Delete this chapter",r.append(i,s),n.append(o,r),E.appendChild(n),e.id===m&&n.classList.add("selected")})}function j(e){if(x&&!confirm("You have unsaved changes. Are you sure you want to switch chapters?"))return;m=e;const t=a.find(n=>n.id===e);t?(w.value=t.content,F.disabled=!1,B.disabled=!0,x=!1):(w.value="",F.disabled=!0,B.disabled=!0),P()}function H(){if(m!==null){const e=a.find(t=>t.id===m);e&&(e.content=w.value,x=!1,B.disabled=!0)}}function Se(e){switch(e){case"classic":return'body{font-family:serif, "Times New Roman", Times;} p{text-indent:1.5em;margin:0;}';case"minimal":return"body{margin:5px;}";case"modern":default:return'body{font-family:sans-serif,"Helvetica Neue",Helvetica,Arial;} p{margin:0 0 1em;}'}}function Ne(e,t,n){const r=String(t||"").split(/\r?\n/).map(i=>i.trim()).filter(Boolean).map(i=>`<p>${v(i)}</p>`).join(`
`);return`<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="zh" lang="zh">
<head>
  <meta charset="utf-8" />
  <title>${v(e||"")}</title>
  <link rel="stylesheet" type="text/css" href="${n}" />
</head>
<body>
  <h2>${v(e||"")}</h2>
  ${r}
</body>
</html>`}async function Re(e){U(),u(5,"Preparing ZIP…");const t=new JSZip,n=S((L||"novel").replace(/\.txt$/i,"")),o=e.length;for(let s=0;s<o;s++){const l=e[s],d=s===0&&l.title.toLowerCase()==="synopsis"?"synopsis":l.title||`chapter${s}`,p=`${String(s).padStart(3,"0")}_${S(d)}.txt`;t.file(p,l.content||""),u(10+s/o*80,`Adding ${p}`),await new Promise(k=>setTimeout(k,0))}u(95,"Generating ZIP…");const r=await t.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}}),i=`${n}_chapters.zip`;te(r,i),u(100,"Done"),setTimeout(A,500)}async function Me(e){U(),u(5,"Preparing EPUB 3…");const t=new JSZip,n=S((L||"novel").replace(/\.txt$/i,"")),o=Le(),r=ve.value.trim()||n,i=Ee.value.trim()||"Unknown Author",s="zh",l=new Date().toISOString().replace(/\.\d+/,"");t.file("mimetype","application/epub+zip",{compression:"STORE"}),t.file("META-INF/container.xml",`<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);const d=t.folder("OEBPS");d.file("style.css",Se(we.value));let h=null,p=null,k=null;if(f){const c=Te(f.type),y=await ee(f);h=`images/cover.${c}`,p="cover-image",k=f.type||"image/jpeg",d.file(h,y)}const N=[];for(let c=0;c<e.length;c++){const y=e[c],ue=c===0&&y.title.toLowerCase()==="synopsis"?"synopsis":y.title||`chapter${c}`,R=`text/${String(c).padStart(3,"0")}_${S(ue)}.xhtml`,me=Ne(y.title,y.content,"../style.css");d.file(R,me),N.push({id:`chap${c}`,href:R,title:y.title||`Chapter ${c}`}),u(10+c/e.length*70,`Adding ${R}`),await new Promise(pe=>setTimeout(pe,0))}const se=N.map(c=>`<li><a href="${c.href.replace("text/","")}">${v(c.title)}</a></li>`).join(`
    `),ae=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="${s}" lang="${s}">
<head>
    <title>${v(r)}</title>
    <meta charset="utf-8"/>
</head>
<body>
    <nav epub:type="toc" id="toc">
        <h1>Table of Contents</h1>
        <ol>
        ${se}
        </ol>
    </nav>
</body>
</html>`;d.file("nav.xhtml",ae);const C=[],_=[];C.push('<item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>'),C.push('<item id="css" href="style.css" media-type="text/css"/>'),h&&C.push(`<item id="${p}" href="${h}" media-type="${k}" properties="cover-image"/>`);for(const c of N)C.push(`<item id="${c.id}" href="${c.href}" media-type="application/xhtml+xml"/>`),_.push(`<itemref idref="${c.id}"/>`);const ce=`<?xml version="1.0" encoding="utf-8"?>
<package version="3.0" unique-identifier="BookId" xmlns="http://www.idpf.org/2007/opf">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>${v(r)}</dc:title>
    <dc:creator id="creator">${v(i)}</dc:creator>
    <dc:language>${s}</dc:language>
    <dc:identifier id="BookId">urn:uuid:${o}</dc:identifier>
    <meta property="dcterms:modified">${l}</meta>
    <meta refines="#creator" property="role" scheme="marc:relators">aut</meta>
  </metadata>
  <manifest>
    ${C.join(`
    `)}
  </manifest>
  <spine>
    ${_.join(`
    `)}
  </spine>
</package>`;d.file("content.opf",ce),u(95,"Packaging EPUB…");const le=await t.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}}),de=`${n}.epub`;te(le,de),u(100,"Done"),setTimeout(A,500)}async function re(e){if(!e){g("No file selected","error");return}if(!(e.type==="text/plain"||/\.txt$/i.test(e.name))){g("Please choose a .txt file.","error");return}try{U(),u(5,"Reading file…");const t=await ee(e);u(25,"Decoding text…");const n=xe.value;$=await Ce(t,n),L=e.name||"novel.txt",ye.textContent=`Loaded: ${L}`,g(`Loaded: ${L}`,"success"),G.disabled=!1,Z(),u(100,"Ready"),setTimeout(A,300)}catch(t){console.error(t),A(),g("Failed to read file.","error")}}J.addEventListener("change",e=>re(e.target.files&&e.target.files[0]));function oe(e){if(f=e||null,f){if(!String(f.type||"").startsWith("image/")){g("Cover must be an image file.","error"),f=null,M.textContent="Or drag and drop image here";return}M.textContent=`Cover: ${f.name}`,g(`Cover loaded: ${f.name}`,"success")}else M.textContent="Or drag and drop image here"}X.addEventListener("change",e=>oe(e.target.files&&e.target.files[0]));function ie(e,t,n){e.addEventListener("dragover",o=>{o.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",o=>{o.preventDefault(),e.classList.remove("drag-over")}),e.addEventListener("drop",o=>{o.preventDefault(),e.classList.remove("drag-over");const r=o.dataTransfer.files&&o.dataTransfer.files[0];r&&(t.files=o.dataTransfer.files,n(r))}),e.addEventListener("click",()=>t.click())}ie(fe,J,re);ie(ge,X,oe);D.addEventListener("change",()=>{he.style.display=D.value==="custom"?"block":"none",Z()});z.addEventListener("input",Z);Ie.addEventListener("click",()=>{const e=document.createElement("div");e.className="rule-item";const t=document.createElement("input");t.type="text",t.placeholder="Enter regex pattern to remove...";const n=document.createElement("button");n.textContent="Remove",n.className="small-btn",n.onclick=()=>e.remove(),e.append(t,n),W.appendChild(e)});G.addEventListener("click",()=>{if(!$){g("Select a .txt file first.","error");return}g("Processing…");const e=Ae($);e&&(a=e,m=a.length>0?a[0].id:null,x=!1,Y.style.display="none",K.style.display="block",j(m))});be.addEventListener("click",()=>{x&&!confirm("You have unsaved changes. Are you sure you want to go back? All edits will be lost.")||(Y.style.display="block",K.style.display="none")});Be.addEventListener("click",()=>{x&&H(),Re(a)});$e.addEventListener("click",()=>{x&&H(),Me(a)});E.addEventListener("click",e=>{const t=e.target.closest("li");if(!t)return;const n=parseInt(t.dataset.id,10);if(e.target.tagName==="BUTTON"){const o=e.target.textContent,r=a.findIndex(i=>i.id===n);o==="Del"?confirm(`Are you sure you want to delete "${a[r].title}"?`)&&(a.splice(r,1),n===m&&(m=null,w.value=""),P()):o==="Merge ↓"&&r>0&&(a[r-1].content+=`

`+a[r].content,a.splice(r,1),n===m&&j(a[r-1].id),P())}else e.target.tagName!=="INPUT"&&j(n)});let b=null;E.addEventListener("dragstart",e=>{b=e.target.closest("li")});E.addEventListener("dragover",e=>{e.preventDefault();const t=e.target.closest("li");t&&t!==b&&(document.querySelectorAll(".drag-over-item").forEach(n=>n.classList.remove("drag-over-item")),t.classList.add("drag-over-item"))});E.addEventListener("dragleave",e=>{var t;(t=e.target.closest("li"))==null||t.classList.remove("drag-over-item")});E.addEventListener("drop",e=>{e.preventDefault(),document.querySelectorAll(".drag-over-item").forEach(n=>n.classList.remove("drag-over-item"));const t=e.target.closest("li");if(t&&b&&t!==b){const n=parseInt(b.dataset.id,10),o=parseInt(t.dataset.id,10),r=a.findIndex(l=>l.id===n),i=a.findIndex(l=>l.id===o),[s]=a.splice(r,1);a.splice(i,0,s),P()}b=null});w.addEventListener("input",()=>{x=!0,B.disabled=!1});B.addEventListener("click",H);F.addEventListener("click",()=>{if(m===null)return;const e=w.selectionStart,t=a.findIndex(d=>d.id===m);if(t===-1)return;const n=a[t],o=n.content,r=o.substring(0,e),i=o.substring(e);if(i.trim()===""){alert("Cannot split at the end of the chapter.");return}n.content=r;const l={id:Math.max(...a.map(d=>d.id))+1,title:`${n.title} (Part 2)`,content:i};a.splice(t+1,0,l),w.value=r,x=!1,B.disabled=!0,P()});
